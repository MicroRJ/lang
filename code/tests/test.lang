/* is a little weird that we use  lang to test lang code */
__logging(false)
let prevdir = pwd()
finally _chdir(prevdir)

let workdir = "code/tests"
pf("running all tests in: ", workdir)

_chdir(workdir)

let sysfile = fopen("tests.ignore","wb")
fpf(sysfile,"test scores:\n")
finally fpf(sysfile,"end of test run");

numfails = 0

let list = listdir(".",fun(file,flags) ? {
	iff file.name:match("*.test.lang") ? {
		leave false
	}
	let _time = clocktime()
	finally pf(" => took: ", timediffs(_time))
	pf("[TEST]: ", file.name)
	/* -- todo: ensure the test does declare
	more globals, store the global count
	beforehand, and then compare with after
	loading the file */
	load file.path
	numfails = numfails + 1
	/* failed is a global */
	if failed ? pf("[FAILED]")
	leave true
})


if numfails == 1 ? {
	pf(numfails, " test failed")
} elif numfails > 1 ? {
	pf(numfails, " tests failed")
} else {
	pf("all tests succeeded")
}


